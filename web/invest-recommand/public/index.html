<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invest Recommand</title>
  <style>
    body{margin:0;background:#111315;color:#e5e7eb;font-family:Inter,Arial,sans-serif}
    .wrap{max-width:1280px;margin:0 auto;padding:18px}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;background:#1a1d21;border:1px solid #2b3138;border-radius:14px;padding:14px}
    .badge{background:#374151;color:#f3f4f6;padding:7px 12px;border-radius:999px;font-size:13px}
    .muted{color:#9aa4b2}
    button{background:#4b5563;border:0;color:#fff;padding:9px 12px;border-radius:10px;cursor:pointer}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px}
    .kpi .item{background:#1a1d21;border:1px solid #2b3138;border-radius:10px;padding:10px}
    .card{background:#1a1d21;border:1px solid #2b3138;border-radius:12px;padding:14px;margin-top:12px}
    .big{font-size:30px;font-weight:700;line-height:1.2}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:980px){.kpi{grid-template-columns:repeat(2,1fr)}.row{grid-template-columns:1fr}}
    a{color:#cbd5e1}
    .tiny{font-size:12px;color:#97a1ae}
    .top-loader{position:fixed;top:0;left:0;right:0;height:3px;background:transparent;z-index:9999;overflow:hidden;display:none}
    .top-loader .bar{position:absolute;height:100%;width:28%;background:#9ca3af;animation:slide 1.1s linear infinite;border-radius:999px}
    @keyframes slide{0%{left:-30%}100%{left:100%}}
  </style>
</head>
<body>
  <div id="topLoader" class="top-loader"><div class="bar"></div></div>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1 id="pageTitle" style="margin:0">Invest Recommand Â· Trading Desk</h1>
        <div id="pageSubtitle" class="muted">Desk View: Top pick, execution plan, rankings, indicators</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <span id="marketBadge" class="badge">LIVE SCANNER</span>
        <button onclick="loadData()">ìƒˆë¡œ ì¡°íšŒ</button>
      </div>
    </div>

    <div class="kpi" id="kpiRow">
      <div class="item"><div class="tiny">Top Pick</div><b id="kpiSymbol">-</b></div>
      <div class="item"><div class="tiny">ì¢…í•©ì ìˆ˜</div><b id="kpiScore">-</b></div>
      <div class="item"><div class="tiny">ì˜ˆìƒìˆ˜ìµ(1ì°¨)</div><b id="kpiRet">-</b></div>
      <div class="item"><div class="tiny">Risk/Reward</div><b id="kpiRR">-</b></div>
    </div>

    <div id="meta" class="card"></div>
    <div class="card">ğŸ“ ê³¼ê±° ì¶”ì²œ ê¸°ë¡ ì¡°íšŒëŠ” <a href="/invest-recommend/calendar">/invest-recommend/calendar</a> ì—ì„œ í™•ì¸</div>
    <div id="notrade" class="card" style="display:none"></div>
    <div id="top" class="card"></div>
    <div id="riskAdjustedTop5" class="row"></div>
    <div id="highReturnTop5" class="row"></div>
    <div id="breakdown" class="row"></div>
  </div>

<script>
function fmt(v,d=2){return (v===null||v===undefined)?'-':Number(v).toLocaleString(undefined,{maximumFractionDigits:d});}
function getMarket(){
  const m = new URLSearchParams(location.search).get('market');
  return (m==='us'||m==='kr') ? m : 'all';
}
function marketText(m){
  if(m==='us') return 'US';
  if(m==='kr') return 'KR';
  return 'KR+US';
}
function setMarketHeader(){
  const m = getMarket();
  document.getElementById('marketBadge').textContent = `LIVE SCANNER Â· ${marketText(m)}`;
  document.getElementById('pageTitle').textContent = `Invest Recommand Â· Trading Desk (${marketText(m)})`;
  document.getElementById('pageSubtitle').textContent = m==='us' ? 'ë¯¸êµ­ì£¼ì‹ ì¶”ì²œ ì „ìš© ë·°' : (m==='kr' ? 'í•œêµ­ì£¼ì‹ ì¶”ì²œ ì „ìš© ë·°' : 'KR+US í†µí•© ì¶”ì²œ ë·°');
}
function setLoading(on){
  const el=document.getElementById('topLoader');
  if(!el) return;
  el.style.display = on ? 'block' : 'none';
}
async function apiGet(url){
  setLoading(true);
  try{
    const res = await fetch(url, { cache: 'no-store' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    return await res.json();
  } finally {
    setLoading(false);
  }
}
function pctFrom(base, target){
  if(base===null||base===undefined||target===null||target===undefined||Number(base)===0) return null;
  return ((Number(target)-Number(base))/Number(base))*100;
}
function fmtPct(v,d=2){
  if(v===null||v===undefined||Number.isNaN(Number(v))) return '-';
  const n = Number(v);
  const sign = n>0?'+':'';
  return `${sign}${n.toLocaleString(undefined,{maximumFractionDigits:d})}%`;
}
function productDesc(symbol,name,category){
  const s = String(symbol||'').toUpperCase();
  const dict = {
    EEM:'ì‹ í¥êµ­(ì¤‘êµ­Â·ì¸ë„Â·ëŒ€ë§ŒÂ·ë¸Œë¼ì§ˆ ë“±) ëŒ€í˜•ì£¼ì— ë¶„ì‚° íˆ¬ìí•˜ëŠ” ETF',
    EFA:'ë¯¸êµ­ ì œì™¸ ì„ ì§„êµ­(ìœ ëŸ½Â·ì¼ë³¸ ë“±) ì£¼ì‹ì— ë¶„ì‚° íˆ¬ìí•˜ëŠ” ETF',
    LQD:'ë¯¸êµ­ íˆ¬ìë“±ê¸‰ íšŒì‚¬ì±„ì— íˆ¬ìí•˜ëŠ” ETF (ìƒëŒ€ì ìœ¼ë¡œ ë°©ì–´ì  ì„±ê²©)',
    VNQ:'ë¯¸êµ­ ìƒì¥ ë¦¬ì¸ (REITs)ì— íˆ¬ìí•˜ëŠ” ë¶€ë™ì‚° ETF',
    TLT:'ë¯¸êµ­ 20ë…„ ì´ìƒ ì¥ê¸°êµ­ì±„ì— íˆ¬ìí•˜ëŠ” ETF (ê¸ˆë¦¬ ë¯¼ê°ë„ ë†’ìŒ)'
  };
  return dict[s] || `${category||'ìì‚°'} ì¹´í…Œê³ ë¦¬ì˜ ${name||symbol||'íˆ¬ììƒí’ˆ'}`;
}
function expectedHorizon(ttlTradingDays){
  const d = Number(ttlTradingDays);
  if(!Number.isFinite(d) || d<=0) return 'ê¸°ê°„ ì •ë³´ ì—†ìŒ';
  if(d<=3) return `ë‹¨ê¸°(ì•½ ${d}ê±°ë˜ì¼ ì´ë‚´)`;
  if(d<=7) return `ë‹¨ê¸°~ìŠ¤ìœ™(ì•½ ${d}ê±°ë˜ì¼ ì´ë‚´)`;
  return `ìŠ¤ìœ™(ì•½ ${d}ê±°ë˜ì¼ ì´ë‚´)`;
}
function detailLink(symbol){
  return `<a href='/invest-recommend/symbol/${encodeURIComponent(symbol)}' title='ì¶”ì²œê·¼ê±° ìƒì„¸'>ğŸ” ê·¼ê±° ìƒì„¸</a>`;
}
function recommendationWhy(r, mode='risk'){
  const c = r?.components || {};
  const m = c.momentum || {};
  const rc = c.reportConsensus || {};
  const crowd = c.crowd || {};
  const risk = c.risk || {};
  const tech = c.technical || {};
  const liq = c.liquidityScore;

  const reasons = [];
  if(mode==='risk') reasons.push(`RR ${fmt(r.riskReward)} (ìœ„í—˜ 1 ëŒ€ë¹„ ê¸°ëŒ€ìˆ˜ìµ)`);
  if(mode==='return') reasons.push(`ì˜ˆìƒìˆ˜ìµ ${fmtPct(r.expectedReturnPct)} (1ì°¨ ìµì ˆ ê¸°ì¤€)`);

  reasons.push(`ë¦¬í¬íŠ¸í•©ì˜ ${fmt(rc.score)}ì  (ëª©í‘œê°€ ê´´ë¦¬ ${fmtPct(rc.upsidePct)})`);
  reasons.push(`êµ°ì¤‘ì‹ í˜¸ ${fmt(crowd.score)}ì  (í†¤ ${fmt(crowd.tone,0)}, í—¤ë“œë¼ì¸ ${fmt(crowd.headlineCount,0)}ê°œ)`);
  reasons.push(`ê¸°ìˆ ë¶„ì„ ${fmt(tech.score)}ì  (RSI ${fmt(tech.rsi14)} / MA20 ì´ê²© ${fmtPct(tech.distMa20Pct)} / 20ì¼ê³ ì ëŒ€ë¹„ ${fmtPct(tech.from20dHighPct)} / ì…‹ì—… ${tech.setup||'-'})`);
  reasons.push(`ìœ ë™ì„± ${fmt(liq)}ì  Â· ë¦¬ìŠ¤í¬ ${fmt(risk.score)}ì  (ë³€ë™ì„± ${fmtPct(risk.volPct)} / MDD ${fmtPct(risk.maxDrawdownPct)})`);
  reasons.push(`(ì°¸ê³ ) ëª¨ë©˜í…€ ${fmt(m.score)}ì  (1M ${fmtPct(m.m1Pct)} / 3M ${fmtPct(m.m3Pct)} / 6M ${fmtPct(m.m6Pct)})`);
  reasons.push(`ì¢…í•©ì ìˆ˜ ${fmt(r.score)} = 0.35R + 0.25C + 0.15L + 0.10V + 0.15T`);

  return reasons.join('<br>');
}

async function renderMiniChart(symbol, elId){
  const el = document.getElementById(elId);
  if(!el) return;

  try{
    const res = await fetch(`/api/chart/${encodeURIComponent(symbol)}?period=3mo&interval=1d`);
    const d = await res.json();
    if(!res.ok || !d.ok || !d.open?.length || !d.high?.length || !d.low?.length || !d.close?.length){
      el.innerHTML = `<div class='tiny'>ì°¨íŠ¸ ë¡œë”© ì‹¤íŒ¨ Â· <a href='https://finance.yahoo.com/quote/${symbol}' target='_blank'>Yahoo ì°¨íŠ¸ ë³´ê¸°</a></div>`;
      return;
    }

    const n = Math.min(d.open.length, d.high.length, d.low.length, d.close.length);
    if(!n){
      el.innerHTML = `<div class='tiny'>ì°¨íŠ¸ ë°ì´í„° ì—†ìŒ</div>`;
      return;
    }

    const o = d.open.slice(-80).map(Number);
    const hArr = d.high.slice(-80).map(Number);
    const lArr = d.low.slice(-80).map(Number);
    const c = d.close.slice(-80).map(Number);
    const vArr = (d.volume || []).slice(-80).map(Number);
    const m = o.length;

    const all = [...hArr, ...lArr].filter(v=>Number.isFinite(v));
    if(!all.length){
      el.innerHTML = `<div class='tiny'>ì°¨íŠ¸ ë°ì´í„° ì—†ìŒ</div>`;
      return;
    }

    const sma = (arr, p)=>arr.map((_,i)=>{
      if(i < p-1) return null;
      const w = arr.slice(i-p+1,i+1).filter(Number.isFinite);
      if(w.length!==p) return null;
      return w.reduce((a,b)=>a+b,0)/p;
    });
    const ma20 = sma(c,20);
    const ma60 = sma(c,60);

    const w = 340, hPx = 180;
    const pL = 8, pR = 46, pT = 10, pB = 16;
    const volH = 42;
    const priceH = hPx - pT - pB - volH - 8;
    const plotW = w - pL - pR;

    const minRaw = Math.min(...all);
    const maxRaw = Math.max(...all);
    const pad = (maxRaw - minRaw) * 0.06;
    const min = minRaw - pad;
    const max = maxRaw + pad;
    const span = (max - min) || 1;
    const y = (v) => pT + (max - v) / span * priceH;

    const volTop = pT + priceH + 8;
    const maxVol = Math.max(...vArr.filter(Number.isFinite), 1);

    const slot = plotW / (m || 1);
    const bodyW = Math.max(2, Math.min(7, slot * 0.62));

    const grid = [];
    for(let i=0;i<=4;i++){
      const gy = pT + (priceH/4)*i;
      grid.push(`<line x1='${pL}' y1='${gy.toFixed(2)}' x2='${w-pR}' y2='${gy.toFixed(2)}' stroke='#24304f' stroke-width='1'/>`);
    }

    const wick = [];
    const body = [];
    const vols = [];
    for(let i=0;i<m;i++){
      const cx = pL + slot*i + slot/2;
      const oy = y(o[i]);
      const cy = y(c[i]);
      const hy = y(hArr[i]);
      const ly = y(lArr[i]);
      const up = c[i] >= o[i];
      const color = up ? '#22c55e' : '#ef4444';

      wick.push(`<line x1='${cx.toFixed(2)}' y1='${hy.toFixed(2)}' x2='${cx.toFixed(2)}' y2='${ly.toFixed(2)}' stroke='${color}' stroke-width='1.1'/>`);
      const top = Math.min(oy, cy);
      const bh = Math.max(Math.abs(cy - oy), 1.2);
      body.push(`<rect x='${(cx-bodyW/2).toFixed(2)}' y='${top.toFixed(2)}' width='${bodyW.toFixed(2)}' height='${bh.toFixed(2)}' rx='0.6' fill='${color}'/>`);

      const vol = Number.isFinite(vArr[i]) ? vArr[i] : 0;
      const vh = (vol / maxVol) * volH;
      vols.push(`<rect x='${(cx-bodyW/2).toFixed(2)}' y='${(volTop + (volH-vh)).toFixed(2)}' width='${bodyW.toFixed(2)}' height='${Math.max(vh,0.8).toFixed(2)}' fill='${up ? '#1f9d55' : '#b91c1c'}' opacity='0.75'/>`);
    }

    const toPath = (arr)=>{
      const pts = [];
      for(let i=0;i<m;i++){
        if(!Number.isFinite(arr[i])) continue;
        const x = pL + slot*i + slot/2;
        const yy = y(arr[i]);
        pts.push(`${x.toFixed(2)},${yy.toFixed(2)}`);
      }
      return pts.join(' ');
    };

    const ma20Path = toPath(ma20);
    const ma60Path = toPath(ma60);

    const maxTxt = maxRaw.toLocaleString(undefined,{maximumFractionDigits:0});
    const minTxt = minRaw.toLocaleString(undefined,{maximumFractionDigits:0});

    el.innerHTML = `
      <svg viewBox='0 0 ${w} ${hPx}' width='100%' height='180' preserveAspectRatio='xMidYMid meet'>
        <rect x='0' y='0' width='${w}' height='${hPx}' fill='#0f172a' rx='6'/>
        ${grid.join('')}
        ${wick.join('')}
        ${body.join('')}
        ${ma20Path ? `<polyline fill='none' stroke='#f59e0b' stroke-width='1.4' points='${ma20Path}'/>` : ''}
        ${ma60Path ? `<polyline fill='none' stroke='#60a5fa' stroke-width='1.4' points='${ma60Path}'/>` : ''}
        <line x1='${pL}' y1='${volTop-1}' x2='${w-pR}' y2='${volTop-1}' stroke='#24304f' stroke-width='1'/>
        ${vols.join('')}
        <text x='${w-pR+4}' y='${(pT+10).toFixed(1)}' fill='#93a4c7' font-size='10'>${maxTxt}</text>
        <text x='${w-pR+4}' y='${(pT+priceH).toFixed(1)}' fill='#93a4c7' font-size='10'>${minTxt}</text>
        <text x='${pL}' y='${(hPx-4).toFixed(1)}' fill='#f59e0b' font-size='10'>MA20</text>
        <text x='${(pL+38).toFixed(1)}' y='${(hPx-4).toFixed(1)}' fill='#60a5fa' font-size='10'>MA60</text>
        <text x='${(w-pR-28).toFixed(1)}' y='${(volTop+10).toFixed(1)}' fill='#93a4c7' font-size='9'>VOL</text>
      </svg>
    `;
  }catch(_){
    el.innerHTML = `<div class='tiny'>ì°¨íŠ¸ ë¡œë”© ì‹¤íŒ¨ Â· <a href='https://finance.yahoo.com/quote/${symbol}' target='_blank'>Yahoo ì°¨íŠ¸ ë³´ê¸°</a></div>`;
  }
}

async function loadData(){
  const market = getMarket();
  const d = await apiGet(`/api/report?market=${market}&t=${Date.now()}`);

  document.getElementById('meta').innerHTML = `
    <b>ìƒì„±ì‹œê°:</b> ${new Date(d.generatedAt).toLocaleString()}<br>
    <b>ëª¨ë¸:</b> ${d.model}<br>
    <b>ì ìˆ˜ì‹:</b> ${d.methodology}
  `;

  const notrade = document.getElementById('notrade');
  if(d.noTrade){
    notrade.style.display='block';
    notrade.innerHTML = `<b>ì˜¤ëŠ˜ì€ ê´€ë§ ê¶Œì¥</b><br>${d.noTradeReason || ''}`;
  }else{
    notrade.style.display='none';
    notrade.innerHTML='';
  }

  const x = d.topPick;
  if(!x){
    document.getElementById('kpiSymbol').textContent='-';
    document.getElementById('kpiScore').textContent='-';
    document.getElementById('kpiRet').textContent='-';
    document.getElementById('kpiRR').textContent='-';
    document.getElementById('top').innerHTML = 'ì¶”ì²œ í›„ë³´ ì—†ìŒ';
    document.getElementById('riskAdjustedTop5').innerHTML = '';
    document.getElementById('highReturnTop5').innerHTML = '';
    document.getElementById('breakdown').innerHTML = '';
    return;
  }

  document.getElementById('kpiSymbol').textContent = `${x.symbol} (${x.name})`;
  document.getElementById('kpiScore').textContent = fmt(x.score);
  document.getElementById('kpiRet').textContent = fmtPct(x.expectedReturnPct);
  document.getElementById('kpiRR').textContent = fmt(x.riskReward);

  const topLossPct = pctFrom(x.currentPrice, x.plan.stopLoss);
  const topProfit1Pct = pctFrom(x.currentPrice, x.plan.takeProfit1);
  const topProfit2Pct = pctFrom(x.currentPrice, x.plan.takeProfit2);

  document.getElementById('top').innerHTML = `
    <div class='big'>Top Pick: ${x.symbol} (${x.name})</div>
    <div>${detailLink(x.symbol)}</div>
    <div>ì¹´í…Œê³ ë¦¬: ${x.category} / ì¢…í•©ì ìˆ˜: <b>${fmt(x.score)}</b></div>
    <div>í˜„ì¬ê°€: ${fmt(x.currentPrice)}</div>
    <div><b>ìƒí’ˆ ì„¤ëª…:</b> ${productDesc(x.symbol, x.name, x.category)}</div>
    <hr>
    <div><b>ìš´ìš© ê³„íš</b></div>
    <div>ì§„ì…ê°€: ${fmt(x.plan.entryZone[0])} ~ ${fmt(x.plan.entryZone[1])}</div>
    <div>ì†ì ˆê°€: ${fmt(x.plan.stopLoss)} / 1ì°¨ ìµì ˆ: ${fmt(x.plan.takeProfit1)} / 2ì°¨ ìµì ˆ: ${fmt(x.plan.takeProfit2)}</div>
    <div><b>ì˜ˆìƒ ì†ì‹¤ë¥ :</b> ${fmtPct(topLossPct)} / <b>ì˜ˆìƒ ìˆ˜ìµë¥ :</b> 1ì°¨ ${fmtPct(topProfit1Pct)} Â· 2ì°¨ ${fmtPct(topProfit2Pct)}</div>
    <div><b>ìˆ˜ìµë¥  í‰ê°€ ì‹œì :</b> ëª©í‘œê°€ ë„ë‹¬ ì‹œì  ê¸°ì¤€ (${expectedHorizon(x.plan.ttlTradingDays)})</div>
    <div>ìœ íš¨ê¸°ê°„: ${x.plan.ttlTradingDays}ê±°ë˜ì¼</div>
    <div style='margin-top:8px'><b>ì¶”ì²œ ê·¼ê±° ìš”ì•½:</b> ê¸°ìˆ /ë¦¬í¬íŠ¸/ë¦¬ìŠ¤í¬/ë‰´ìŠ¤ ì ìˆ˜ ì¡°í•© ê¸°ë°˜ Â· ${detailLink(x.symbol)}</div>
    <div style='margin-top:10px;margin-bottom:10px'>
      <b>ë¯¸ë‹ˆ ì°¨íŠ¸ (3ê°œì›”)</b><br>
      <div id='mini-top' style='height:190px;min-height:190px;margin-top:6px;background:#0f172a;border:1px solid #24304f;border-radius:8px;padding:4px;box-sizing:border-box;overflow:hidden;'></div>
    </div>
    <div style='margin-top:8px'>ë¬´íš¨í™” ì¡°ê±´: ${x.plan.invalidationRule}</div>
    <div style='margin-top:8px'>
      <a href='${x.links.yahoo}' target='_blank'>Yahoo</a> Â·
      <a href='${x.links.analysis}' target='_blank'>Analysis</a> Â·
      <a href='${x.links.news}' target='_blank'>News</a>
    </div>
  `;

  const riskAdjustedTop5 = (d.riskAdjustedRankings || d.rankings || []).slice(0,5);
  const highReturnTop5 = (d.highReturnRankings || d.rankings || []).slice(0,5);

  document.getElementById('riskAdjustedTop5').innerHTML = `
    <div class='card' style='grid-column:1/-1'><b>ğŸ“Œ ìœ„í—˜ëŒ€ë¹„ ê¸°ëŒ€ìˆ˜ìµ ìƒìœ„ 5</b></div>
  ` + riskAdjustedTop5.map((r, idx) => {
    const lossPct = pctFrom(r.currentPrice, r.plan.stopLoss);
    const profitPct = pctFrom(r.currentPrice, r.plan.takeProfit1);
    return `
    <div class='card'>
      <b>#${idx+1} ${r.symbol} (${r.name})</b> Â· ${detailLink(r.symbol)}<br>
      ì ìˆ˜: ${fmt(r.score)} / í˜„ì¬ê°€: ${fmt(r.currentPrice)}<br>
      <b>ì„¤ëª…:</b> ${productDesc(r.symbol, r.name, r.category)}<br>
      ì§„ì…: ${fmt(r.plan.entryZone[0])}~${fmt(r.plan.entryZone[1])}<br>
      ì†ì ˆ: ${fmt(r.plan.stopLoss)} / ìµì ˆ1: ${fmt(r.plan.takeProfit1)}<br>
      <b>ì˜ˆìƒ ì†ì‹¤ë¥ :</b> ${fmtPct(lossPct)} / <b>ì˜ˆìƒ ìˆ˜ìµë¥ :</b> ${fmtPct(profitPct)}<br>
      <b>RR(ê¸°ëŒ€ìˆ˜ìµ/ìœ„í—˜):</b> ${fmt(r.riskReward || (profitPct && lossPct ? (profitPct/Math.abs(lossPct)) : null))}<br>
      <b>ìˆ˜ìµë¥  í‰ê°€ ì‹œì :</b> ${expectedHorizon(r.plan.ttlTradingDays)}<br>
      <b>ë¯¸ë‹ˆ ì°¨íŠ¸ (3ê°œì›”):</b><br><div id='risk-mini-${idx}' style='height:190px;min-height:190px;margin-top:6px;background:#0f172a;border:1px solid #24304f;border-radius:8px;padding:4px;box-sizing:border-box;overflow:hidden;'></div><br>
      <b>ì¶”ì²œ ê·¼ê±°:</b> ìš”ì•½ë§Œ í‘œì‹œ Â· ${detailLink(r.symbol)}
    </div>
  `}).join('');

  document.getElementById('highReturnTop5').innerHTML = `
    <div class='card' style='grid-column:1/-1'><b>ğŸš€ ì ˆëŒ€ ê¸°ëŒ€ìˆ˜ìµ ìƒìœ„ 5</b></div>
  ` + highReturnTop5.map((r, idx) => {
    const lossPct = pctFrom(r.currentPrice, r.plan.stopLoss);
    const profitPct = pctFrom(r.currentPrice, r.plan.takeProfit1);
    return `
    <div class='card'>
      <b>#${idx+1} ${r.symbol} (${r.name})</b> Â· ${detailLink(r.symbol)}<br>
      ì ìˆ˜: ${fmt(r.score)} / í˜„ì¬ê°€: ${fmt(r.currentPrice)}<br>
      <b>ì„¤ëª…:</b> ${productDesc(r.symbol, r.name, r.category)}<br>
      ì§„ì…: ${fmt(r.plan.entryZone[0])}~${fmt(r.plan.entryZone[1])}<br>
      ì†ì ˆ: ${fmt(r.plan.stopLoss)} / ìµì ˆ1: ${fmt(r.plan.takeProfit1)}<br>
      <b>ì˜ˆìƒ ì†ì‹¤ë¥ :</b> ${fmtPct(lossPct)} / <b>ì˜ˆìƒ ìˆ˜ìµë¥ :</b> ${fmtPct(profitPct)}<br>
      <b>RR(ê¸°ëŒ€ìˆ˜ìµ/ìœ„í—˜):</b> ${fmt(r.riskReward || (profitPct && lossPct ? (profitPct/Math.abs(lossPct)) : null))}<br>
      <b>ìˆ˜ìµë¥  í‰ê°€ ì‹œì :</b> ${expectedHorizon(r.plan.ttlTradingDays)}<br>
      <b>ë¯¸ë‹ˆ ì°¨íŠ¸ (3ê°œì›”):</b><br><div id='ret-mini-${idx}' style='height:190px;min-height:190px;margin-top:6px;background:#0f172a;border:1px solid #24304f;border-radius:8px;padding:4px;box-sizing:border-box;overflow:hidden;'></div><br>
      <b>ì¶”ì²œ ê·¼ê±°:</b> ìš”ì•½ë§Œ í‘œì‹œ Â· ${detailLink(r.symbol)}
    </div>
  `}).join('');

  await renderMiniChart(x.symbol, 'mini-top');
  for(let i=0;i<riskAdjustedTop5.length;i++){
    await renderMiniChart(riskAdjustedTop5[i].symbol, `risk-mini-${i}`);
  }
  for(let i=0;i<highReturnTop5.length;i++){
    await renderMiniChart(highReturnTop5[i].symbol, `ret-mini-${i}`);
  }

  const c = x.components;
  document.getElementById('breakdown').innerHTML = `
    <div class='card'>
      <b>R) ë¦¬í¬íŠ¸/ê¸°ê´€ í•©ì˜</b><br>
      ì ìˆ˜: ${fmt(c.reportConsensus.score)}<br>
      ëª©í‘œê°€ ê´´ë¦¬: ${fmt(c.reportConsensus.upsidePct)}%<br>
      ì¶”ì²œì§€ìˆ˜: ${fmt(c.reportConsensus.recommendationMean)} / ì˜ê²¬ìˆ˜: ${fmt(c.reportConsensus.analystOpinions,0)}
    </div>
    <div class='card'>
      <b>T) ê¸°ìˆ ì  ë¶„ì„(ì°¨íŠ¸/ê°€ê²©)</b><br>
      ì ìˆ˜: ${fmt(c.technical?.score)} / ì…‹ì—…: ${c.technical?.setup||'-'}<br>
      RSI(14): ${fmt(c.technical?.rsi14)} / MA20 ì´ê²©: ${fmt(c.technical?.distMa20Pct)}% / 20ì¼ ê³ ì ëŒ€ë¹„: ${fmt(c.technical?.from20dHighPct)}%
    </div>
    <div class='card'>
      <b>C) êµ°ì¤‘/ë‰´ìŠ¤ ì‹œê·¸ë„</b><br>
      ì ìˆ˜: ${fmt(c.crowd.score)} / í†¤: ${fmt(c.crowd.tone,0)} / í—¤ë“œë¼ì¸: ${fmt(c.crowd.headlineCount,0)}ê°œ
      <ul>${(c.crowd.headlines||[]).map(h=>`<li>${h}</li>`).join('')}</ul>
    </div>
    <div class='card'>
      <b>L+V) ìœ ë™ì„±/ë¦¬ìŠ¤í¬</b><br>
      ìœ ë™ì„± ì ìˆ˜: ${fmt(c.liquidityScore)}<br>
      ë¦¬ìŠ¤í¬ ì ìˆ˜: ${fmt(c.risk.score)} / ë³€ë™ì„±: ${fmt(c.risk.volPct)}% / ìµœëŒ€ë‚™í­: ${fmt(c.risk.maxDrawdownPct)}%
    </div>
    <div class='card'>
      <b>(ì°¸ê³ ) M) ê°€ê²© ëª¨ë©˜í…€</b><br>
      ì ìˆ˜: ${fmt(c.momentum.score)}<br>
      1M: ${fmt(c.momentum.m1Pct)}% / 3M: ${fmt(c.momentum.m3Pct)}% / 6M: ${fmt(c.momentum.m6Pct)}%
    </div>
  `;
}

setMarketHeader();
loadData();
</script>
</body>
</html>
