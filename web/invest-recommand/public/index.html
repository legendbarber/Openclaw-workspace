<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invest Recommand</title>
  <style>
    body{margin:0;background:#0b1220;color:#e5e7eb;font-family:Arial,sans-serif}
    .wrap{max-width:1000px;margin:0 auto;padding:20px}
    .card{background:#111827;border:1px solid #1f2937;border-radius:14px;padding:16px;margin-top:12px}
    .big{font-size:28px;font-weight:700}
    .muted{color:#9ca3af}
    button{background:#2563eb;border:0;color:#fff;padding:9px 12px;border-radius:8px;cursor:pointer}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:900px){.row{grid-template-columns:1fr}}
    a{color:#93c5fd}
    .cal-head{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:10px}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .cal-dow{font-size:12px;color:#9ca3af;text-align:center}
    .cal-day{border:1px solid #1f2937;border-radius:8px;min-height:54px;padding:6px;font-size:12px;position:relative;background:#0f172a;cursor:pointer}
    .cal-day.empty{opacity:.35;cursor:default}
    .cal-day.active{outline:2px solid #2563eb}
    .dot{width:7px;height:7px;border-radius:50%;background:#22c55e;position:absolute;right:6px;bottom:6px}
    .tiny{font-size:12px;color:#9ca3af}
    .top-loader{position:fixed;top:0;left:0;right:0;height:3px;background:transparent;z-index:9999;overflow:hidden;display:none}
    .top-loader .bar{position:absolute;height:100%;width:28%;background:#60a5fa;animation:slide 1.1s linear infinite;border-radius:999px}
    @keyframes slide{0%{left:-30%}100%{left:100%}}
  </style>
</head>
<body>
  <div id="topLoader" class="top-loader"><div class="bar"></div></div>
  <div class="wrap">
    <h1>ğŸ¯ Invest Recommand</h1>
    <div class="muted">í•œêµ­/ë¯¸êµ­ ë‹¨ì¼ì£¼ì‹ ì¶”ì²œ (ìœ„í—˜ëŒ€ë¹„ ê¸°ëŒ€ìˆ˜ìµ + ì ˆëŒ€ ê¸°ëŒ€ìˆ˜ìµ)</div>
    <button onclick="loadData()">ìƒˆë¡œ ì¡°íšŒ</button>

    <div id="meta" class="card"></div>
    <div class="card">ğŸ“ ê³¼ê±° ì¶”ì²œ ê¸°ë¡ ì¡°íšŒëŠ” <a href="/invest-recommend/calendar">/invest-recommend/calendar</a> (invest-recommend í•˜ìœ„ ê²½ë¡œ)ì—ì„œ í™•ì¸í•˜ì„¸ìš”.</div>
    <div id="notrade" class="card" style="display:none"></div>
    <div id="top" class="card"></div>
    <div id="riskAdjustedTop5" class="row"></div>
    <div id="highReturnTop5" class="row"></div>
    <div id="breakdown" class="row"></div>
  </div>

<script>
function fmt(v,d=2){return (v===null||v===undefined)?'-':Number(v).toLocaleString(undefined,{maximumFractionDigits:d});}
function setLoading(on){
  const el=document.getElementById('topLoader');
  if(!el) return;
  el.style.display = on ? 'block' : 'none';
}
async function apiGet(url){
  setLoading(true);
  try{
    const res = await fetch(url, { cache: 'no-store' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    return await res.json();
  } finally {
    setLoading(false);
  }
}
function pctFrom(base, target){
  if(base===null||base===undefined||target===null||target===undefined||Number(base)===0) return null;
  return ((Number(target)-Number(base))/Number(base))*100;
}
function fmtPct(v,d=2){
  if(v===null||v===undefined||Number.isNaN(Number(v))) return '-';
  const n = Number(v);
  const sign = n>0?'+':'';
  return `${sign}${n.toLocaleString(undefined,{maximumFractionDigits:d})}%`;
}
function productDesc(symbol,name,category){
  const s = String(symbol||'').toUpperCase();
  const dict = {
    EEM:'ì‹ í¥êµ­(ì¤‘êµ­Â·ì¸ë„Â·ëŒ€ë§ŒÂ·ë¸Œë¼ì§ˆ ë“±) ëŒ€í˜•ì£¼ì— ë¶„ì‚° íˆ¬ìí•˜ëŠ” ETF',
    EFA:'ë¯¸êµ­ ì œì™¸ ì„ ì§„êµ­(ìœ ëŸ½Â·ì¼ë³¸ ë“±) ì£¼ì‹ì— ë¶„ì‚° íˆ¬ìí•˜ëŠ” ETF',
    LQD:'ë¯¸êµ­ íˆ¬ìë“±ê¸‰ íšŒì‚¬ì±„ì— íˆ¬ìí•˜ëŠ” ETF (ìƒëŒ€ì ìœ¼ë¡œ ë°©ì–´ì  ì„±ê²©)',
    VNQ:'ë¯¸êµ­ ìƒì¥ ë¦¬ì¸ (REITs)ì— íˆ¬ìí•˜ëŠ” ë¶€ë™ì‚° ETF',
    TLT:'ë¯¸êµ­ 20ë…„ ì´ìƒ ì¥ê¸°êµ­ì±„ì— íˆ¬ìí•˜ëŠ” ETF (ê¸ˆë¦¬ ë¯¼ê°ë„ ë†’ìŒ)'
  };
  return dict[s] || `${category||'ìì‚°'} ì¹´í…Œê³ ë¦¬ì˜ ${name||symbol||'íˆ¬ììƒí’ˆ'}`;
}
function expectedHorizon(ttlTradingDays){
  const d = Number(ttlTradingDays);
  if(!Number.isFinite(d) || d<=0) return 'ê¸°ê°„ ì •ë³´ ì—†ìŒ';
  if(d<=3) return `ë‹¨ê¸°(ì•½ ${d}ê±°ë˜ì¼ ì´ë‚´)`;
  if(d<=7) return `ë‹¨ê¸°~ìŠ¤ìœ™(ì•½ ${d}ê±°ë˜ì¼ ì´ë‚´)`;
  return `ìŠ¤ìœ™(ì•½ ${d}ê±°ë˜ì¼ ì´ë‚´)`;
}
function recommendationWhy(r, mode='risk'){
  const c = r?.components || {};
  const m = c.momentum || {};
  const rc = c.reportConsensus || {};
  const crowd = c.crowd || {};
  const risk = c.risk || {};
  const tech = c.technical || {};
  const liq = c.liquidityScore;

  const reasons = [];
  if(mode==='risk') reasons.push(`RR ${fmt(r.riskReward)} (ìœ„í—˜ 1 ëŒ€ë¹„ ê¸°ëŒ€ìˆ˜ìµ)`);
  if(mode==='return') reasons.push(`ì˜ˆìƒìˆ˜ìµ ${fmtPct(r.expectedReturnPct)} (1ì°¨ ìµì ˆ ê¸°ì¤€)`);

  reasons.push(`ë¦¬í¬íŠ¸í•©ì˜ ${fmt(rc.score)}ì  (ëª©í‘œê°€ ê´´ë¦¬ ${fmtPct(rc.upsidePct)})`);
  reasons.push(`êµ°ì¤‘ì‹ í˜¸ ${fmt(crowd.score)}ì  (í†¤ ${fmt(crowd.tone,0)}, í—¤ë“œë¼ì¸ ${fmt(crowd.headlineCount,0)}ê°œ)`);
  reasons.push(`ê¸°ìˆ ë¶„ì„ ${fmt(tech.score)}ì  (RSI ${fmt(tech.rsi14)} / MA20 ì´ê²© ${fmtPct(tech.distMa20Pct)} / 20ì¼ê³ ì ëŒ€ë¹„ ${fmtPct(tech.from20dHighPct)} / ì…‹ì—… ${tech.setup||'-'})`);
  reasons.push(`ìœ ë™ì„± ${fmt(liq)}ì  Â· ë¦¬ìŠ¤í¬ ${fmt(risk.score)}ì  (ë³€ë™ì„± ${fmtPct(risk.volPct)} / MDD ${fmtPct(risk.maxDrawdownPct)})`);
  reasons.push(`(ì°¸ê³ ) ëª¨ë©˜í…€ ${fmt(m.score)}ì  (1M ${fmtPct(m.m1Pct)} / 3M ${fmtPct(m.m3Pct)} / 6M ${fmtPct(m.m6Pct)})`);
  reasons.push(`ì¢…í•©ì ìˆ˜ ${fmt(r.score)} = 0.35R + 0.25C + 0.15L + 0.10V + 0.15T`);

  return reasons.join('<br>');
}

async function renderMiniChart(symbol, elId){
  const el = document.getElementById(elId);
  if(!el) return;

  try{
    const res = await fetch(`/api/chart/${encodeURIComponent(symbol)}?period=3mo&interval=1d`);
    const d = await res.json();
    if(!res.ok || !d.ok || !d.close?.length){
      el.innerHTML = `<div class='tiny'>ì°¨íŠ¸ ë°ì´í„° ì—†ìŒ</div>`;
      return;
    }

    const values = d.close.map(Number).filter(v=>Number.isFinite(v));
    if(!values.length){
      el.innerHTML = `<div class='tiny'>ì°¨íŠ¸ ë°ì´í„° ì—†ìŒ</div>`;
      return;
    }

    const w = 260, h = 70, p = 4;
    const min = Math.min(...values);
    const max = Math.max(...values);
    const span = (max - min) || 1;

    const pts = values.map((v,i)=>{
      const x = p + (i/(values.length-1 || 1)) * (w - p*2);
      const y = h - p - ((v - min)/span) * (h - p*2);
      return `${x.toFixed(1)},${y.toFixed(1)}`;
    }).join(' ');

    const up = values[values.length-1] >= values[0];
    const color = up ? '#22c55e' : '#ef4444';

    el.innerHTML = `
      <svg viewBox='0 0 ${w} ${h}' width='100%' height='70' preserveAspectRatio='none'>
        <polyline fill='none' stroke='${color}' stroke-width='2' points='${pts}' />
      </svg>
    `;
  }catch(_){
    el.innerHTML = `<div class='tiny'>ì°¨íŠ¸ ë¡œë”© ì‹¤íŒ¨</div>`;
  }
}

async function loadData(){
  const d = await apiGet(`/api/report?t=${Date.now()}`);

  document.getElementById('meta').innerHTML = `
    <b>ìƒì„±ì‹œê°:</b> ${new Date(d.generatedAt).toLocaleString()}<br>
    <b>ëª¨ë¸:</b> ${d.model}<br>
    <b>ì ìˆ˜ì‹:</b> ${d.methodology}
  `;

  const notrade = document.getElementById('notrade');
  if(d.noTrade){
    notrade.style.display='block';
    notrade.innerHTML = `<b>ì˜¤ëŠ˜ì€ ê´€ë§ ê¶Œì¥</b><br>${d.noTradeReason || ''}`;
  }else{
    notrade.style.display='none';
    notrade.innerHTML='';
  }

  const x = d.topPick;
  if(!x){
    document.getElementById('top').innerHTML = 'ì¶”ì²œ í›„ë³´ ì—†ìŒ';
    document.getElementById('riskAdjustedTop5').innerHTML = '';
    document.getElementById('highReturnTop5').innerHTML = '';
    document.getElementById('breakdown').innerHTML = '';
    return;
  }

  const topLossPct = pctFrom(x.currentPrice, x.plan.stopLoss);
  const topProfit1Pct = pctFrom(x.currentPrice, x.plan.takeProfit1);
  const topProfit2Pct = pctFrom(x.currentPrice, x.plan.takeProfit2);

  document.getElementById('top').innerHTML = `
    <div class='big'>Top Pick: ${x.symbol} (${x.name})</div>
    <div>ì¹´í…Œê³ ë¦¬: ${x.category} / ì¢…í•©ì ìˆ˜: <b>${fmt(x.score)}</b></div>
    <div>í˜„ì¬ê°€: ${fmt(x.currentPrice)}</div>
    <div><b>ìƒí’ˆ ì„¤ëª…:</b> ${productDesc(x.symbol, x.name, x.category)}</div>
    <hr>
    <div><b>ìš´ìš© ê³„íš</b></div>
    <div>ì§„ì…ê°€: ${fmt(x.plan.entryZone[0])} ~ ${fmt(x.plan.entryZone[1])}</div>
    <div>ì†ì ˆê°€: ${fmt(x.plan.stopLoss)} / 1ì°¨ ìµì ˆ: ${fmt(x.plan.takeProfit1)} / 2ì°¨ ìµì ˆ: ${fmt(x.plan.takeProfit2)}</div>
    <div><b>ì˜ˆìƒ ì†ì‹¤ë¥ :</b> ${fmtPct(topLossPct)} / <b>ì˜ˆìƒ ìˆ˜ìµë¥ :</b> 1ì°¨ ${fmtPct(topProfit1Pct)} Â· 2ì°¨ ${fmtPct(topProfit2Pct)}</div>
    <div><b>ìˆ˜ìµë¥  í‰ê°€ ì‹œì :</b> ëª©í‘œê°€ ë„ë‹¬ ì‹œì  ê¸°ì¤€ (${expectedHorizon(x.plan.ttlTradingDays)})</div>
    <div>ìœ íš¨ê¸°ê°„: ${x.plan.ttlTradingDays}ê±°ë˜ì¼</div>
    <div style='margin-top:8px'><b>ì¶”ì²œ ê·¼ê±°:</b><br>${recommendationWhy(x, 'risk')}</div>
    <div style='margin-top:10px'><b>ë¯¸ë‹ˆ ì°¨íŠ¸ (3ê°œì›”)</b><br><div id='mini-top' style='height:70px'></div></div>
    <div>ë¬´íš¨í™” ì¡°ê±´: ${x.plan.invalidationRule}</div>
    <div style='margin-top:8px'>
      <a href='${x.links.yahoo}' target='_blank'>Yahoo</a> Â·
      <a href='${x.links.analysis}' target='_blank'>Analysis</a> Â·
      <a href='${x.links.news}' target='_blank'>News</a>
    </div>
  `;

  const riskAdjustedTop5 = (d.riskAdjustedRankings || d.rankings || []).slice(0,5);
  const highReturnTop5 = (d.highReturnRankings || d.rankings || []).slice(0,5);

  document.getElementById('riskAdjustedTop5').innerHTML = `
    <div class='card' style='grid-column:1/-1'><b>ğŸ“Œ ìœ„í—˜ëŒ€ë¹„ ê¸°ëŒ€ìˆ˜ìµ ìƒìœ„ 5</b></div>
  ` + riskAdjustedTop5.map((r, idx) => {
    const lossPct = pctFrom(r.currentPrice, r.plan.stopLoss);
    const profitPct = pctFrom(r.currentPrice, r.plan.takeProfit1);
    return `
    <div class='card'>
      <b>#${idx+1} ${r.symbol} (${r.name})</b><br>
      ì ìˆ˜: ${fmt(r.score)} / í˜„ì¬ê°€: ${fmt(r.currentPrice)}<br>
      <b>ì„¤ëª…:</b> ${productDesc(r.symbol, r.name, r.category)}<br>
      ì§„ì…: ${fmt(r.plan.entryZone[0])}~${fmt(r.plan.entryZone[1])}<br>
      ì†ì ˆ: ${fmt(r.plan.stopLoss)} / ìµì ˆ1: ${fmt(r.plan.takeProfit1)}<br>
      <b>ì˜ˆìƒ ì†ì‹¤ë¥ :</b> ${fmtPct(lossPct)} / <b>ì˜ˆìƒ ìˆ˜ìµë¥ :</b> ${fmtPct(profitPct)}<br>
      <b>RR(ê¸°ëŒ€ìˆ˜ìµ/ìœ„í—˜):</b> ${fmt(r.riskReward || (profitPct && lossPct ? (profitPct/Math.abs(lossPct)) : null))}<br>
      <b>ìˆ˜ìµë¥  í‰ê°€ ì‹œì :</b> ${expectedHorizon(r.plan.ttlTradingDays)}<br>
      <b>ë¯¸ë‹ˆ ì°¨íŠ¸ (3ê°œì›”):</b><br><div id='risk-mini-${idx}' style='height:70px'></div><br>
      <b>ì¶”ì²œ ê·¼ê±°:</b> ${recommendationWhy(r, 'risk')}
    </div>
  `}).join('');

  document.getElementById('highReturnTop5').innerHTML = `
    <div class='card' style='grid-column:1/-1'><b>ğŸš€ ì ˆëŒ€ ê¸°ëŒ€ìˆ˜ìµ ìƒìœ„ 5</b></div>
  ` + highReturnTop5.map((r, idx) => {
    const lossPct = pctFrom(r.currentPrice, r.plan.stopLoss);
    const profitPct = pctFrom(r.currentPrice, r.plan.takeProfit1);
    return `
    <div class='card'>
      <b>#${idx+1} ${r.symbol} (${r.name})</b><br>
      ì ìˆ˜: ${fmt(r.score)} / í˜„ì¬ê°€: ${fmt(r.currentPrice)}<br>
      <b>ì„¤ëª…:</b> ${productDesc(r.symbol, r.name, r.category)}<br>
      ì§„ì…: ${fmt(r.plan.entryZone[0])}~${fmt(r.plan.entryZone[1])}<br>
      ì†ì ˆ: ${fmt(r.plan.stopLoss)} / ìµì ˆ1: ${fmt(r.plan.takeProfit1)}<br>
      <b>ì˜ˆìƒ ì†ì‹¤ë¥ :</b> ${fmtPct(lossPct)} / <b>ì˜ˆìƒ ìˆ˜ìµë¥ :</b> ${fmtPct(profitPct)}<br>
      <b>RR(ê¸°ëŒ€ìˆ˜ìµ/ìœ„í—˜):</b> ${fmt(r.riskReward || (profitPct && lossPct ? (profitPct/Math.abs(lossPct)) : null))}<br>
      <b>ìˆ˜ìµë¥  í‰ê°€ ì‹œì :</b> ${expectedHorizon(r.plan.ttlTradingDays)}<br>
      <b>ë¯¸ë‹ˆ ì°¨íŠ¸ (3ê°œì›”):</b><br><div id='ret-mini-${idx}' style='height:70px'></div><br>
      <b>ì¶”ì²œ ê·¼ê±°:</b> ${recommendationWhy(r, 'return')}
    </div>
  `}).join('');

  await renderMiniChart(x.symbol, 'mini-top');
  for(let i=0;i<riskAdjustedTop5.length;i++){
    await renderMiniChart(riskAdjustedTop5[i].symbol, `risk-mini-${i}`);
  }
  for(let i=0;i<highReturnTop5.length;i++){
    await renderMiniChart(highReturnTop5[i].symbol, `ret-mini-${i}`);
  }

  const c = x.components;
  document.getElementById('breakdown').innerHTML = `
    <div class='card'>
      <b>R) ë¦¬í¬íŠ¸/ê¸°ê´€ í•©ì˜</b><br>
      ì ìˆ˜: ${fmt(c.reportConsensus.score)}<br>
      ëª©í‘œê°€ ê´´ë¦¬: ${fmt(c.reportConsensus.upsidePct)}%<br>
      ì¶”ì²œì§€ìˆ˜: ${fmt(c.reportConsensus.recommendationMean)} / ì˜ê²¬ìˆ˜: ${fmt(c.reportConsensus.analystOpinions,0)}
    </div>
    <div class='card'>
      <b>T) ê¸°ìˆ ì  ë¶„ì„(ì°¨íŠ¸/ê°€ê²©)</b><br>
      ì ìˆ˜: ${fmt(c.technical?.score)} / ì…‹ì—…: ${c.technical?.setup||'-'}<br>
      RSI(14): ${fmt(c.technical?.rsi14)} / MA20 ì´ê²©: ${fmt(c.technical?.distMa20Pct)}% / 20ì¼ ê³ ì ëŒ€ë¹„: ${fmt(c.technical?.from20dHighPct)}%
    </div>
    <div class='card'>
      <b>C) êµ°ì¤‘/ë‰´ìŠ¤ ì‹œê·¸ë„</b><br>
      ì ìˆ˜: ${fmt(c.crowd.score)} / í†¤: ${fmt(c.crowd.tone,0)} / í—¤ë“œë¼ì¸: ${fmt(c.crowd.headlineCount,0)}ê°œ
      <ul>${(c.crowd.headlines||[]).map(h=>`<li>${h}</li>`).join('')}</ul>
    </div>
    <div class='card'>
      <b>L+V) ìœ ë™ì„±/ë¦¬ìŠ¤í¬</b><br>
      ìœ ë™ì„± ì ìˆ˜: ${fmt(c.liquidityScore)}<br>
      ë¦¬ìŠ¤í¬ ì ìˆ˜: ${fmt(c.risk.score)} / ë³€ë™ì„±: ${fmt(c.risk.volPct)}% / ìµœëŒ€ë‚™í­: ${fmt(c.risk.maxDrawdownPct)}%
    </div>
    <div class='card'>
      <b>(ì°¸ê³ ) M) ê°€ê²© ëª¨ë©˜í…€</b><br>
      ì ìˆ˜: ${fmt(c.momentum.score)}<br>
      1M: ${fmt(c.momentum.m1Pct)}% / 3M: ${fmt(c.momentum.m3Pct)}% / 6M: ${fmt(c.momentum.m6Pct)}%
    </div>
  `;
}

loadData();
</script>
</body>
</html>
