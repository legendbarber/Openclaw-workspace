<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invest Snapshot History</title>
  <style>
    body{margin:0;background:#0b1220;color:#e5e7eb;font-family:Arial,sans-serif}
    .wrap{max-width:1000px;margin:0 auto;padding:20px}
    .card{background:#111827;border:1px solid #1f2937;border-radius:14px;padding:16px;margin-top:12px}
    button{background:#2563eb;border:0;color:#fff;padding:9px 12px;border-radius:8px;cursor:pointer}
    a{color:#93c5fd}
    .cal-head{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:10px}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .cal-dow{font-size:12px;color:#9ca3af;text-align:center}
    .cal-day{border:1px solid #1f2937;border-radius:8px;min-height:54px;padding:6px;font-size:12px;position:relative;background:#0f172a;cursor:pointer}
    .cal-day.empty{opacity:.35;cursor:default}
    .cal-day.active{outline:2px solid #2563eb}
    .dot{width:7px;height:7px;border-radius:50%;background:#22c55e;position:absolute;right:6px;bottom:6px}
    .tiny{font-size:12px;color:#9ca3af}
    .top-loader{position:fixed;top:0;left:0;right:0;height:3px;background:transparent;z-index:9999;overflow:hidden;display:none}
    .top-loader .bar{position:absolute;height:100%;width:28%;background:#60a5fa;animation:slide 1.1s linear infinite;border-radius:999px}
    @keyframes slide{0%{left:-30%}100%{left:100%}}
  </style>
</head>
<body>
  <div id="topLoader" class="top-loader"><div class="bar"></div></div>
  <div class="wrap">
    <h1>ğŸ—‚ íˆ¬ì ì¶”ì²œ íˆìŠ¤í† ë¦¬</h1>
    <div class="card">ì›” ë‹¨ìœ„ ìº˜ë¦°ë”ì—ì„œ ê¸°ë¡ëœ ë‚ ì§œ(â—)ë¥¼ ëˆŒëŸ¬ ë‹¹ì‹œ ì¶”ì²œì„ ì¡°íšŒí•˜ì„¸ìš”. <a href="/invest-recommend">í˜„ì¬ ì¶”ì²œìœ¼ë¡œ ëŒì•„ê°€ê¸°</a></div>

    <div class="card">
      <div class="cal-head">
        <button onclick="moveMonth(-1)">â—€ ì´ì „ë‹¬</button>
        <b id="calTitle">-</b>
        <button onclick="moveMonth(1)">ë‹¤ìŒë‹¬ â–¶</button>
      </div>
      <div class="cal-grid" id="calDow"></div>
      <div class="cal-grid" id="calGrid"></div>
      <div class="tiny" style="margin-top:8px">â— ì ì´ ì°íŒ ë‚ ì§œ = í•´ë‹¹ ë‚ ì§œ ì¶”ì²œ ê¸°ë¡ ì¡´ì¬</div>
    </div>

    <div id="snapshotDetail" class="card">ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ì¼ìì˜ ì¶”ì²œ ê¸°ë¡ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.</div>
  </div>

<script>
function fmt(v,d=2){return (v===null||v===undefined)?'-':Number(v).toLocaleString(undefined,{maximumFractionDigits:d});}
function setLoading(on){
  const el=document.getElementById('topLoader');
  if(!el) return;
  el.style.display = on ? 'block' : 'none';
}
async function apiGet(url){
  setLoading(true);
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error('HTTP '+res.status);
    return await res.json();
  } finally {
    setLoading(false);
  }
}
function fmtPct(v,d=2){

  if(v===null||v===undefined||Number.isNaN(Number(v))) return '-';
  const n = Number(v);
  const sign = n>0?'+':'';
  return `${sign}${n.toLocaleString(undefined,{maximumFractionDigits:d})}%`;
}

let snapshotDates = new Set();
let calCursor = new Date();
let selectedDate = null;

async function loadSnapshots(){
  const ym = `${calCursor.getFullYear()}-${String(calCursor.getMonth()+1).padStart(2,'0')}`;
  const data = await apiGet(`/api/snapshots/month/${ym}`);
  snapshotDates = new Set(data.dates || []);
  renderCalendar();
}

function renderCalendar(){
  const y = calCursor.getFullYear();
  const m = calCursor.getMonth();
  document.getElementById('calTitle').textContent = `${y}ë…„ ${m+1}ì›”`;

  const dows = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  document.getElementById('calDow').innerHTML = dows.map(d=>`<div class='cal-dow'>${d}</div>`).join('');

  const first = new Date(y,m,1);
  const start = first.getDay();
  const lastDate = new Date(y,m+1,0).getDate();
  const cells = [];
  for(let i=0;i<start;i++) cells.push(`<div class='cal-day empty'></div>`);
  for(let d=1; d<=lastDate; d++){
    const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const has = snapshotDates.has(ds);
    const active = selectedDate===ds ? 'active' : '';
    cells.push(`<div class='cal-day ${active}' onclick="pickDate('${ds}')">${d}${has?"<span class='dot'></span>":''}</div>`);
  }
  document.getElementById('calGrid').innerHTML = cells.join('');
}

async function moveMonth(delta){
  calCursor = new Date(calCursor.getFullYear(), calCursor.getMonth()+delta, 1);
  await loadSnapshots();
}

async function pickDate(ds){
  selectedDate = ds;
  renderCalendar();
  const detail = document.getElementById('snapshotDetail');
  if(!snapshotDates.has(ds)){
    detail.innerHTML = `<b>${ds}</b><br>ì´ ë‚ ì§œì—ëŠ” ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.`;
    return;
  }

  detail.innerHTML = `<b>${ds}</b><br>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...`;
  try{
    const s = await apiGet(`/api/snapshots/${ds}`);
    const perf = await apiGet(`/api/snapshots/${ds}/performance`);

    const top = s.topPick || {};
    const perfMap = new Map((perf.items||[]).map(x=>[x.symbol, x]));

    const withPerf = (x)=>{
      const p = perfMap.get(x.symbol);
      if(!p) return 'í˜„ì¬ê°€/ë“±ë½ ë°ì´í„° ì—†ìŒ';
      return `í˜„ì¬ ${fmt(p.currentPrice)} / í•´ë‹¹ì¼ ëŒ€ë¹„ ${fmtPct(p.changePct)}`;
    };

    const risk = (s.riskAdjustedTop5||[]).slice(0,5)
      .map((x,i)=>`#${i+1} ${x.symbol} (${fmtPct(x.expectedReturnPct)} / RR ${fmt(x.riskReward)}) Â· ${withPerf(x)}`)
      .join('<br>');

    const ret = (s.highReturnTop5||[]).slice(0,5)
      .map((x,i)=>`#${i+1} ${x.symbol} (${fmtPct(x.expectedReturnPct)}) Â· ${withPerf(x)}`)
      .join('<br>');

    detail.innerHTML = `
      <b>${ds} ì €ì¥ ê¸°ë¡</b><br>
      ìƒì„±ì‹œê°: ${new Date(s.generatedAt).toLocaleString()}<br><br>
      <b>Top Pick</b><br>
      ${top.symbol || '-'} (${top.name || '-'}) / ì ìˆ˜ ${fmt(top.score)} / ê¸°ëŒ€ìˆ˜ìµ ${fmtPct(top.expectedReturnPct)} / ì†ì‹¤ ${fmtPct(top.expectedLossPct)}<br><br>
      <b>ìœ„í—˜ëŒ€ë¹„ ê¸°ëŒ€ìˆ˜ìµ ìƒìœ„ 5</b><br>${risk || '-'}<br><br>
      <b>ì ˆëŒ€ ê¸°ëŒ€ìˆ˜ìµ ìƒìœ„ 5</b><br>${ret || '-'}
    `;
  }catch(_){
    detail.innerHTML = `<b>${ds}</b><br>ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.`;
  }
}

loadSnapshots();
</script>
</body>
</html>
