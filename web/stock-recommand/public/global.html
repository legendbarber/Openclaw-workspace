<!doctype html>
<html lang='ko'>
<head>
  <meta charset='utf-8'/>
  <meta name='viewport' content='width=device-width, initial-scale=1'/>
  <title>Global Invest Recommender</title>
  <style>
    body{font-family:Arial,sans-serif;background:#0b1220;color:#e5e7eb;margin:0}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .card{background:#111827;border:1px solid #1f2937;border-radius:12px;padding:14px;margin-top:12px}
    button{background:#2563eb;border:0;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
    small{color:#9ca3af}.grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    a{color:#93c5fd}
  </style>
</head>
<body>
  <div class='wrap'>
    <h1>ğŸŒ Global Invest Recommender</h1>
    <small>ì „ì„¸ê³„ ìì‚°êµ° ìë™ ìŠ¤ì½”ì–´ë§ + íˆ¬ììš´ìš© ê³„íš</small><br><br>
    <div><a href='/stock-recommand'>/stock-recommand</a> Â· <a href='/invest-recommand'>/invest-recommand</a></div><br>
    <label>ì „ëµ ëª¨ë“œ:
      <select id='mode' onchange='onModeChange()'>
        <option value='balanced' selected>ë°¸ëŸ°ìŠ¤</option>
        <option value='aggressive'>ê³µê²©í˜•</option>
      </select>
    </label>
    <button onclick='loadData()'>ìƒˆë¡œ ì¡°íšŒ</button>
    <div id='macro' class='card'></div>
    <div id='riskOnly' class='card' style='display:none'></div>
    <div id='picks' class='grid'></div>
    <div id='disc' class='card'></div>
  </div>

<script>
function onModeChange(){
  const mode = document.getElementById('mode').value;
  localStorage.setItem('invest-mode', mode);
  loadData();
}

async function loadData(){
  const mode = document.getElementById('mode').value;
  const res = await fetch(`/api/global-report?top=7&mode=${encodeURIComponent(mode)}`);
  const d = await res.json();
  document.getElementById('macro').innerHTML = `
    <b>ìƒì„±:</b> ${new Date(d.generatedAt).toLocaleString()}<br>
    <b>ëª¨ë¸:</b> ${d.model || '-'}<br>
    <b>ì „ëµëª¨ë“œ:</b> ${d.mode || '-'}<br>
    <b>ë ˆì§:</b> risk_on=${d.macro?.risk_on}, VIX=${d.macro?.vix}, DXY 1M=${d.macro?.dxy_1m_pct}%<br>
    <b>ë°©ë²•ë¡ :</b> ${d.methodology || '-'}<br>
    <b>ë°ì´í„° ì†ŒìŠ¤:</b> ${(d.dataSources || []).join(' / ')}
  `;
  document.getElementById('disc').innerHTML = d.disclaimer || '';

  const riskOnlyEl = document.getElementById('riskOnly');
  if ((d.mode || '').toLowerCase() === 'aggressive') {
    const riskTop = (d.topRiskPicks || []).slice(0,5);
    riskOnlyEl.style.display = 'block';
    riskOnlyEl.innerHTML = `<b>ê³µê²©í˜• ì „ìš© ìƒìœ„(ì£¼ì‹/ì½”ì¸/ë¦¬ì¸ )</b><br>${riskTop.map((r,i)=>`${i+1}. ${r.symbol} (${r.category}) score=${r.score}`).join('<br>')}`;
  } else {
    riskOnlyEl.style.display = 'none';
    riskOnlyEl.innerHTML = '';
  }

  const picks = d.topPicks || [];
  document.getElementById('picks').innerHTML = picks.map((x,i)=>`
    <div class='card'>
      <h3>#${i+1} ${x.symbol} (${x.name})</h3>
      <div>ì¹´í…Œê³ ë¦¬: ${x.category} | ì ìˆ˜: <b>${x.score}</b> | ê¸°ëŒ€3ê°œì›”: <b>${x.expected3mPct}%</b></div>
      <div>í˜„ì¬ê°€: ${x.currentPrice}</div>
      <div><b>ì™œ ì¶”ì²œ?</b></div>
      <ul>${(x.whyRecommended || []).map(r => `<li>${r}</li>`).join('')}</ul>
      <div><b>ì •ë³´ ì†ŒìŠ¤</b>: ${x.source?.priceData || '-'} / ì‹¬ë³¼: ${x.source?.symbol || '-'} / ê¸°ê°„: ${x.source?.lookback || '-'}</div>
      <div><b>ì• ë„ë¦¬ìŠ¤íŠ¸ ì»¨ì„¼ì„œìŠ¤</b>: ëª©í‘œê°€ ${x.source?.consensusData?.targetMeanPrice ?? '-'} / ê´´ë¦¬ìœ¨ ${x.source?.consensusData?.upsidePct ?? '-'}% / ì¶”ì²œì§€ìˆ˜ ${x.source?.consensusData?.recommendationMean ?? '-'} / ì˜ê²¬ìˆ˜ ${x.source?.consensusData?.analystOpinions ?? '-'}</div>
      <div><b>ì»¨ì„¼ì„œìŠ¤ ìƒíƒœ</b>: ${x.source?.consensusData?.status ?? '-'}${x.source?.consensusData?.fallbackFrom ? ` (fallback: ${x.source?.consensusData?.fallbackFrom} â†’ ${x.source?.consensusData?.usedSymbol})` : ''}</div>
      <div><b>ë¦¬í¬íŠ¸/ë‰´ìŠ¤ ì‹œê·¸ë„</b>: ${x.source?.newsData?.source || '-'} / í—¤ë“œë¼ì¸ ${x.source?.newsData?.headlineCount ?? 0}ê°œ / ì ìˆ˜ ${x.source?.newsData?.sentimentScore ?? 0}</div>
      <ul>${(x.source?.newsData?.headlines || []).slice(0,3).map(h => `<li>${h}</li>`).join('')}</ul>
      <div><b>ê¸°ì‚¬ ìš”ì•½ ì¸ì‚¬ì´íŠ¸</b></div>
      <ul>${(x.source?.newsData?.insights || []).map(i => `<li><a href='${i.url}' target='_blank'>${i.title}</a> <span style='color:#9ca3af'>(${i.source || 'source n/a'})</span><br><small>${i.summary}</small></li>`).join('')}</ul>
      <hr>
      <div><b>ìš´ìš© ê³„íš</b></div>
      <div>ì§„ì…ê°€ êµ¬ê°„: ${x.plan?.entryZone?.[0]} ~ ${x.plan?.entryZone?.[1]}</div>
      <div>ì†ì ˆê°€: ${x.plan?.stopLoss}</div>
      <div>1ì°¨ ìµì ˆ: ${x.plan?.takeProfit1}</div>
      <div>2ì°¨ ìµì ˆ: ${x.plan?.takeProfit2}</div>
      <div>ê³„íš ì‚°ì¶œë°©ì‹: ${x.plan?.planBasis || '-'}</div>
      ${(x.plan?.technical) ? `<div>ê¸°ìˆ  ëŒ€ì²´ê·¼ê±°: ATRìœ ì‚¬ ${x.plan.technical.atrProxyPct}% / ì§€ì§€ ${x.plan.technical.support} / ì €í•­ ${x.plan.technical.resistance}</div>` : ''}
      <div>ë³´ìœ ê¸°ê°„: ${x.plan?.holdingPeriod}</div>
      <div>ë§¤ìˆ˜ë°©ë²•: ${x.plan?.whereToBuy}</div>
      <div>ì§‘í–‰ë©”ëª¨: ${x.plan?.executionNote}</div>
      <div>ë¦¬ë°¸ëŸ°ì‹±: ${x.plan?.rebalancingRule}</div>
      <div>ë¹„ì¤‘: ${x.plan?.positionSizing}</div>
      <div>
        <a href='${x.links?.yahoo}' target='_blank'>Yahoo</a> Â·
        <a href='${x.links?.tradingview}' target='_blank'>TradingView</a> Â·
        <a href='${x.links?.yahooAnalysis}' target='_blank'>Yahoo Analysis</a> Â·
        <a href='${x.links?.googleNews}' target='_blank'>Google News</a> Â·
        <a href='${x.links?.googleReports}' target='_blank'>Research Search</a>
      </div>
    </div>
  `).join('');
}

const savedMode = localStorage.getItem('invest-mode');
if (savedMode && ['balanced','aggressive'].includes(savedMode)) {
  document.getElementById('mode').value = savedMode;
}

loadData();
</script>
</body>
</html>
